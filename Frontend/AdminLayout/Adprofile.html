<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="../Common/styles.css">
</head>
<body>
    <header>
        <nav>
            <ul class="tabs">
                <li class="store-name">Channa Stores</li> 
                <li id="accounts-tab" style="display: none;"><a href="userhandling03.html" class="tab">Accounts</a></li>
                <li><a href="Adproducts.html" class="tab">Inventory</a></li>
                <li><a href="Adorders.html" class="tab">Orders</a></li>
                <li><a href="Adprofile.html" class="tab active">Profile</a></li>
                <li class="signout-tab"><a href="../Common/login.html" class="tab">Sign Out</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <h2>User Profile</h2>

        <!-- Update Profile Form -->
        <form id="update-profile-form">
            <label for="name">Name:</label>
            <input type="text" id="name" placeholder="Loading..."><br><br>

            <label for="email">Email:</label>
            <input type="email" id="email" placeholder="Loading..."><br><br>

            <label for="phone">Phone:</label>
            <input type="text" id="phone" placeholder="Loading..."><br><br>

            <button type="submit">Update Profile</button>
        </form>

        <!-- Update Password Section -->
        <section id="update-password">
            <h3>Update Password</h3>
            <form id="update-password-form">
                <label for="current-password">Current Password:</label>
                <input type="password" id="current-password" placeholder="Enter current password" required><br><br>

                <label for="new-password">New Password:</label>
                <input type="password" id="new-password" placeholder="Enter new password" required><br><br>

                <label for="confirm-password">Confirm New Password:</label>
                <input type="password" id="confirm-password" placeholder="Confirm new password" required><br><br>

                <button type="submit">Update Password</button>
            </form>
        </section>

    </main>


    <footer>
        <p>&copy; 2024 Shop Management System</p>
    </footer>


    <script>
        window.onload = function () {
            // Get the user data from localStorage
            const userData = JSON.parse(localStorage.getItem('userData'));

            if (userData) {
                // Get the user ID from the stored user data
                const userID = userData.id;

                // Use localStorage data directly for admin profile
                document.getElementById('name').value = userData.username || '';
                document.getElementById('email').value = userData.email || '';
                document.getElementById('phone').value = '';
                
                // Try to fetch additional admin data if available
                fetch(`http://localhost:8080/api/admins/${userID}`)
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        }
                        throw new Error('Admin record not found');
                    })
                    .then(data => {
                        // Update phone number if available
                        if (data.phoneNumber) {
                            document.getElementById('phone').value = data.phoneNumber;
                        }
                        console.log('Admin data loaded from API:', data);
                    })
                    .catch(error => {
                        console.log('Using basic user data:', error.message);
                    });
            } else {
                console.log('No user data found in localStorage');
                alert('Please log in again.');
                window.location.href = '../Common/login.html';
            }
        };

        // Show accounts tab only for main admin (moved outside window.onload)
        const userData = JSON.parse(localStorage.getItem('userData'));
        if (userData && userData.role === 'admin') {
            document.getElementById('accounts-tab').style.display = 'block';
        }

        // Retrieve user data from localStorage
        const userID = userData ? userData.id : null;

        if (!userID) {
            console.error('User ID not found in localStorage!');
        } else {

            // Update Profile Handler
            document.getElementById('update-profile-form').addEventListener('submit', function (event) {
                event.preventDefault();

                const name = document.getElementById('name').value;
                const email = document.getElementById('email').value;
                const phone = document.getElementById('phone').value;

                const updatedData = {
                    username: name,
                    email: email,
                    phoneNumber: phone
                };

                fetch(`http://localhost:8080/api/admins/${userID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedData),
                })
                    .then((response) => {
                        if (response.ok) {
                            return response.json().catch(() => ({ message: 'Profile updated successfully' }));
                        } else {
                            return response.text().then(text => {
                                throw new Error(text || 'Update failed');
                            });
                        }
                    })
                    .then((data) => {
                        alert('Profile updated successfully!');
                        console.log(data);
                    })
                    .catch((error) => {
                        alert('Error updating profile: ' + error.message);
                        console.error(error);
                    });
            });

            // Update Password Handler
            document.getElementById('update-password-form').addEventListener('submit', function (event) {
                event.preventDefault();

                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                // Validate inputs - we'll let the backend handle password verification
                if (!currentPassword) {
                    alert('Please enter your current password.');
                    return;
                }

                // Check if new password is the same as the current password
                if (currentPassword === newPassword) {
                    alert('New password cannot be the same as the current password!');
                    return;
                }

                // Check if new password and confirm password match
                if (newPassword !== confirmPassword) {
                    alert('New passwords do not match!');
                    return;
                }

                // For password updates, we need to update the user entity
                // This should be handled by a separate endpoint
                alert('Password update functionality needs to be implemented separately.');
                return;
                
                const updatedPasswordData = {
                    password: newPassword
                };

                fetch(`http://localhost:8080/api/admins/${userID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedPasswordData),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        alert('Password updated successfully!');
                        console.log(data);
                        window.location.href = '../Common/login.html'; // Redirect to login page after password updated

                    })
                    .catch((error) => {
                        alert('Error updating password!');
                        console.error(error);
                    });
            });
        }

    </script>
</body>
</html>
